{% extends "base.html" %}

{% block title %}Document Identification Configuration - IDMS{% endblock %}

{% block page_title %}Document Identification Configuration{% endblock %}
{% block page_subtitle %}Manage document types, keywords, and classification settings for automated identification{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="bg-white shadow-sm p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-file-signature mr-3 text-blue-600"></i>
                    Document Identification Configuration
                </h1>
                <p class="text-gray-600 mt-2">Configure document types, keywords, and classification settings for automated document identification</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="loadConfigurations()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 text-sm flex items-center transition-colors">
                    <i class="fas fa-refresh mr-1"></i>
                    Refresh
                </button>
                <button onclick="showAddConfigModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm flex items-center transition-colors">
                    <i class="fas fa-plus mr-1"></i>
                    Add Document Type
                </button>
            </div>
        </div>
    </div>

    <!-- Document Types List -->
    <div class="bg-white shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Document Types</h2>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label for="searchInput" class="text-sm font-medium text-gray-700">Search:</label>
                        <input type="text" id="searchInput" placeholder="Search document types..." 
                               class="px-2 py-1 border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="filterSelect" class="text-sm font-medium text-gray-700">Filter:</label>
                        <select id="filterSelect" class="px-2 py-1 border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Document Types</option>
                            <option value="identity">Identity Documents</option>
                            <option value="financial">Financial Documents</option>
                            <option value="utility">Utility Documents</option>
                            <option value="legal">Legal Documents</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Results Info -->
            <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
                <div id="resultsInfo">Loading document types...</div>
                <div id="paginationInfo"></div>
            </div>
            
            <!-- Classification Settings Section -->
            <div class="border-t border-gray-200 pt-4 mt-4">
                <h3 class="text-md font-semibold text-gray-900 mb-4">Classification Settings</h3>
                <div class="flex items-end gap-4">
                    <div class="w-48">
                        <label for="caseSensitive" class="block text-sm font-medium text-gray-700 mb-2">Case Sensitive</label>
                        <select id="caseSensitive" class="w-full px-2 py-1 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                    <div class="w-32">
                        <label for="minimumKeywords" class="block text-sm font-medium text-gray-700 mb-2">Min Keywords</label>
                        <input type="number" id="minimumKeywords" min="1" max="10" class="w-full px-2 py-1 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="w-48">
                        <label for="fallbackType" class="block text-sm font-medium text-gray-700 mb-2">Fallback Type</label>
                        <input type="text" id="fallbackType" class="w-full px-2 py-1 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="unknown">
                    </div>
                    <div>
                        <button onclick="saveClassificationSettings()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 text-sm flex items-center transition-colors">
                            <i class="fas fa-save mr-1"></i>
                            Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keywords Count</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence Threshold</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="configTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prevPageMobile" onclick="changePage(currentPage - 1)" 
                        class="relative inline-flex items-center px-3 py-1 border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Previous
                </button>
                <button id="nextPageMobile" onclick="changePage(currentPage + 1)" 
                        class="ml-3 relative inline-flex items-center px-3 py-1 border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Next
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700" id="paginationText">
                        Showing <span id="startRecord">0</span> to <span id="endRecord">0</span> of <span id="totalRecords">0</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prevPage" onclick="changePage(currentPage - 1)" 
                                class="relative inline-flex items-center px-2 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="sr-only">Previous</span>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <div id="pageNumbers" class="flex">
                            <!-- Page numbers will be generated here -->
                        </div>
                        
                        <button id="nextPage" onclick="changePage(currentPage + 1)" 
                                class="relative inline-flex items-center px-2 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="sr-only">Next</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Document Type Modal -->
<div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white shadow-xl max-w-2xl w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900" id="modalTitle">
                        <i class="fas fa-plus mr-2 text-blue-600"></i>Add Document Type
                    </h3>
                    <button onclick="hideConfigModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <form id="configForm" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="documentKey" class="block text-sm font-medium text-gray-700 mb-2">Document Key</label>
                        <input type="text" id="documentKey" required
                               class="w-full px-2 py-1 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., pancard, aadhaar">
                    </div>
                    <div>
                        <label for="documentName" class="block text-sm font-medium text-gray-700 mb-2">Document Name</label>
                        <input type="text" id="documentName" required
                               class="w-full px-2 py-1 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., PAN Card, Aadhaar Card">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="documentDescription" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="documentDescription" rows="2" required
                              class="w-full px-2 py-1 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Brief description of the document type"></textarea>
                </div>
                
                <div class="mb-4">
                    <label for="keywords" class="block text-sm font-medium text-gray-700 mb-2">Keywords (one per line)</label>
                    <textarea id="keywords" rows="4" required
                              class="w-full px-2 py-1 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Enter keywords, one per line"></textarea>
                </div>
                
                <div class="mb-4">
                    <label for="confidenceThreshold" class="block text-sm font-medium text-gray-700 mb-2">Confidence Threshold</label>
                    <input type="number" id="confidenceThreshold" min="0" max="1" step="0.1" required
                           class="w-full px-2 py-1 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="0.3">
                </div>
                
                <div id="configError" class="hidden bg-red-50 border border-red-200 p-2 text-red-700 text-sm mb-4">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="configErrorText"></span>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideConfigModal()" 
                            class="px-3 py-1 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-3 py-1 text-sm bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                        <i class="fas fa-save mr-1"></i>Save Document Type
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Keywords View Modal -->
<div id="keywordsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white shadow-xl max-w-2xl w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-key mr-2 text-green-600"></i>Document Keywords
                    </h3>
                    <button onclick="hideKeywordsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <h4 class="text-md font-semibold text-gray-800 mb-2" id="keywordsDocumentName">Document Type</h4>
                    <p class="text-sm text-gray-600 mb-4" id="keywordsDocumentDescription">Description</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Keywords (<span id="keywordsCount">0</span> total)</label>
                    <div id="keywordsList" class="border border-gray-300 p-3 bg-gray-50 max-h-60 overflow-y-auto">
                        <!-- Keywords will be displayed here -->
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confidence Threshold</label>
                    <div class="text-sm text-gray-600" id="keywordsConfidenceThreshold">0.5</div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button onclick="hideKeywordsModal()" 
                            class="px-3 py-1 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors">
                        Close
                    </button>
                    <button onclick="editFromKeywords()" 
                            class="px-3 py-1 text-sm bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                        <i class="fas fa-edit mr-1"></i>Edit Document Type
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>Confirm Deletion
                </h3>
            </div>
            <div class="p-6">
                <p class="text-gray-700 mb-4">Are you sure you want to delete this document type? This action cannot be undone.</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideDeleteModal()" 
                            class="px-3 py-1 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button onclick="confirmDelete()" 
                            class="px-3 py-1 text-sm bg-red-600 text-white hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let currentConfigs = {};
let allConfigs = []; // All configurations for filtering
let filteredConfigs = []; // Filtered configurations
let currentPage = 1;
let recordsPerPage = 6;
let editingKey = null;
let deletingKey = null;
let viewingKey = null;

// Load configurations on page load
document.addEventListener('DOMContentLoaded', function() {
    loadConfigurations();
    loadClassificationSettings();
    
    // Add event listeners for search and filter
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('filterSelect').addEventListener('change', applyFilters);
});

// Load all configurations
async function loadConfigurations() {
    try {
        const response = await fetch('/api/document-identification');
        const data = await response.json();
        
        if (response.ok) {
            currentConfigs = data.configurations;
            prepareConfigurations();
            applyFilters();
        } else {
            if (response.status === 403) {
                showToast('error', 'Access Denied', 'Admin access required');
            } else {
                showToast('error', 'Error', data.detail || 'Failed to load configurations');
            }
        }
    } catch (error) {
        console.error('Error loading configurations:', error);
        showToast('error', 'Error', 'Network error loading configurations');
    }
}

// Load classification settings
async function loadClassificationSettings() {
    try {
        const response = await fetch('/api/document-identification/settings');
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('caseSensitive').value = data.case_sensitive ? 'true' : 'false';
            document.getElementById('minimumKeywords').value = data.minimum_keywords_found || 1;
            document.getElementById('fallbackType').value = data.fallback_document_type || 'unknown';
        } else {
            console.error('Error loading classification settings:', data);
        }
    } catch (error) {
        console.error('Error loading classification settings:', error);
    }
}

// Prepare configurations for filtering and pagination
function prepareConfigurations() {
    // Convert document types to array format
    allConfigs = Object.entries(currentConfigs.document_types || {}).map(([key, value]) => ({
        key,
        name: value.name,
        description: value.description,
        keywords: value.keywords || [],
        keywordsCount: value.keywords ? value.keywords.length : 0,
        confidenceThreshold: value.confidence_threshold || 0.5
    }));
    
    filteredConfigs = [...allConfigs];
    currentPage = 1;
}

// Apply search and filter
function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filterValue = document.getElementById('filterSelect').value;
    
    filteredConfigs = allConfigs.filter(config => {
        const matchesSearch = config.name.toLowerCase().includes(searchTerm) || 
                           config.description.toLowerCase().includes(searchTerm);
        
        let matchesFilter = true;
        if (filterValue) {
            // Simple categorization based on document type
            const identityDocs = ['pancard', 'aadhaar', 'drivers_license', 'passport', 'voter_id'];
            const financialDocs = ['bank_statement', 'salary_slip'];
            const utilityDocs = ['utility_bill'];
            const legalDocs = ['rental_agreement', 'birth_certificate'];
            
            if (filterValue === 'identity') matchesFilter = identityDocs.includes(config.key);
            else if (filterValue === 'financial') matchesFilter = financialDocs.includes(config.key);
            else if (filterValue === 'utility') matchesFilter = utilityDocs.includes(config.key);
            else if (filterValue === 'legal') matchesFilter = legalDocs.includes(config.key);
        }
        
        return matchesSearch && matchesFilter;
    });
    
    currentPage = 1;
    renderConfigurations();
    updatePagination();
}

// Render configurations in table with pagination
function renderConfigurations() {
    const tbody = document.getElementById('configTableBody');
    tbody.innerHTML = '';
    
    if (filteredConfigs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                    No document types found. Click "Add Document Type" to create one.
                </td>
            </tr>
        `;
        updateResultsInfo(0);
        return;
    }
    
    // Calculate pagination
    const startIndex = (currentPage - 1) * recordsPerPage;
    const endIndex = Math.min(startIndex + recordsPerPage, filteredConfigs.length);
    const pageConfigs = filteredConfigs.slice(startIndex, endIndex);
    
    pageConfigs.forEach(config => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${config.name}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${config.description}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${config.keywordsCount}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${config.confidenceThreshold}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="viewKeywords('${config.key}')" class="text-green-600 hover:text-green-900 mr-2" title="View Keywords">
                    <i class="fas fa-eye"></i>
                </button>
                <button onclick="editConfig('${config.key}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteConfig('${config.key}')" class="text-red-600 hover:text-red-900" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    updateResultsInfo(filteredConfigs.length);
}

// Update pagination controls
function updatePagination() {
    const totalPages = Math.ceil(filteredConfigs.length / recordsPerPage);
    
    // Update pagination info
    const startRecord = filteredConfigs.length === 0 ? 0 : (currentPage - 1) * recordsPerPage + 1;
    const endRecord = Math.min(currentPage * recordsPerPage, filteredConfigs.length);
    
    document.getElementById('startRecord').textContent = startRecord;
    document.getElementById('endRecord').textContent = endRecord;
    document.getElementById('totalRecords').textContent = filteredConfigs.length;
    
    // Update pagination buttons
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const prevPageMobile = document.getElementById('prevPageMobile');
    const nextPageMobile = document.getElementById('nextPageMobile');
    
    prevPage.disabled = currentPage <= 1;
    nextPage.disabled = currentPage >= totalPages;
    prevPageMobile.disabled = currentPage <= 1;
    nextPageMobile.disabled = currentPage >= totalPages;
    
    // Generate page numbers
    const pageNumbers = document.getElementById('pageNumbers');
    pageNumbers.innerHTML = '';
    
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        pageButton.className = `relative inline-flex items-center px-3 py-1 border text-sm font-medium ${
            i === currentPage 
                ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' 
                : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
        }`;
        pageButton.onclick = () => changePage(i);
        pageNumbers.appendChild(pageButton);
    }
}

// Change page
function changePage(page) {
    const totalPages = Math.ceil(filteredConfigs.length / recordsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderConfigurations();
        updatePagination();
    }
}

// Update results info
function updateResultsInfo(total) {
    const resultsInfo = document.getElementById('resultsInfo');
    if (total === 0) {
        resultsInfo.textContent = 'No document types found';
    } else {
        resultsInfo.textContent = `Found ${total} document type${total !== 1 ? 's' : ''}`;
    }
}

// Show add configuration modal
function showAddConfigModal() {
    editingKey = null;
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus mr-2 text-blue-600"></i>Add Document Type';
    document.getElementById('configForm').reset();
    hideConfigError();
    document.getElementById('configModal').classList.remove('hidden');
}

// Edit configuration
function editConfig(documentKey) {
    editingKey = documentKey;
    const docType = currentConfigs.document_types[documentKey];
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit mr-2 text-blue-600"></i>Edit Document Type';
    document.getElementById('documentKey').value = documentKey;
    document.getElementById('documentName').value = docType.name;
    document.getElementById('documentDescription').value = docType.description;
    document.getElementById('keywords').value = docType.keywords.join('\n');
    document.getElementById('confidenceThreshold').value = docType.confidence_threshold;
    hideConfigError();
    document.getElementById('configModal').classList.remove('hidden');
}

// View keywords
function viewKeywords(documentKey) {
    viewingKey = documentKey;
    const docType = currentConfigs.document_types[documentKey];
    
    // Populate modal with document information
    document.getElementById('keywordsDocumentName').textContent = docType.name;
    document.getElementById('keywordsDocumentDescription').textContent = docType.description;
    document.getElementById('keywordsCount').textContent = docType.keywords ? docType.keywords.length : 0;
    document.getElementById('keywordsConfidenceThreshold').textContent = docType.confidence_threshold || 0.5;
    
    // Display keywords
    const keywordsList = document.getElementById('keywordsList');
    if (docType.keywords && docType.keywords.length > 0) {
        keywordsList.innerHTML = docType.keywords.map((keyword, index) => `
            <div class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 m-1 border border-blue-200">
                ${index + 1}. ${keyword}
            </div>
        `).join('');
    } else {
        keywordsList.innerHTML = '<div class="text-gray-500 text-sm italic">No keywords defined</div>';
    }
    
    document.getElementById('keywordsModal').classList.remove('hidden');
}

// Delete configuration
function deleteConfig(documentKey) {
    deletingKey = documentKey;
    document.getElementById('deleteModal').classList.remove('hidden');
}

// Hide modals
function hideConfigModal() {
    document.getElementById('configModal').classList.add('hidden');
}

function hideKeywordsModal() {
    document.getElementById('keywordsModal').classList.add('hidden');
}

function hideDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
}

// Edit from keywords modal
function editFromKeywords() {
    hideKeywordsModal();
    editConfig(viewingKey);
}

// Show/hide error messages
function showConfigError(message) {
    const errorDiv = document.getElementById('configError');
    const errorText = document.getElementById('configErrorText');
    errorText.textContent = message;
    errorDiv.classList.remove('hidden');
}

function hideConfigError() {
    document.getElementById('configError').classList.add('hidden');
}

// Handle form submission
document.getElementById('configForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const documentKey = document.getElementById('documentKey').value.trim();
    const documentName = document.getElementById('documentName').value.trim();
    const documentDescription = document.getElementById('documentDescription').value.trim();
    const keywords = document.getElementById('keywords').value.split('\n').map(k => k.trim()).filter(k => k);
    const confidenceThreshold = parseFloat(document.getElementById('confidenceThreshold').value);
    
    if (!documentKey || !documentName || !documentDescription || keywords.length === 0) {
        showConfigError('Please fill in all fields');
        return;
    }
    
    // Check for duplicates (only for new entries)
    if (!editingKey && currentConfigs.document_types && currentConfigs.document_types[documentKey]) {
        showConfigError('A document type with this key already exists');
        return;
    }
    
    try {
        const url = editingKey ? `/api/document-identification/${encodeURIComponent(editingKey)}` : '/api/document-identification';
        const method = editingKey ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                document_key: documentKey,
                document_name: documentName,
                document_description: documentDescription,
                keywords: keywords,
                confidence_threshold: confidenceThreshold
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            hideConfigModal();
            showToast('success', 'Success', data.message);
            loadConfigurations(); // Reload the list
        } else {
            showConfigError(data.message || 'Failed to save document type');
        }
    } catch (error) {
        console.error('Error saving document type:', error);
        showConfigError('Network error. Please try again.');
    }
});

// Confirm delete
async function confirmDelete() {
    if (!deletingKey) return;
    
    try {
        const response = await fetch(`/api/document-identification/${encodeURIComponent(deletingKey)}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            hideDeleteModal();
            showToast('success', 'Success', data.message);
            loadConfigurations(); // Reload the list
        } else {
            showToast('error', 'Error', data.message || 'Failed to delete document type');
        }
    } catch (error) {
        console.error('Error deleting document type:', error);
        showToast('error', 'Error', 'Network error. Please try again.');
    }
}

// Save classification settings
async function saveClassificationSettings() {
    const caseSensitive = document.getElementById('caseSensitive').value === 'true';
    const minimumKeywords = parseInt(document.getElementById('minimumKeywords').value);
    const fallbackType = document.getElementById('fallbackType').value.trim();
    
    try {
        const response = await fetch('/api/document-identification/settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                case_sensitive: caseSensitive,
                minimum_keywords_found: minimumKeywords,
                fallback_document_type: fallbackType
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('success', 'Success', 'Classification settings saved successfully');
        } else {
            showToast('error', 'Error', data.message || 'Failed to save classification settings');
        }
    } catch (error) {
        console.error('Error saving classification settings:', error);
        showToast('error', 'Error', 'Network error. Please try again.');
    }
}
</script>
{% endblock %}
